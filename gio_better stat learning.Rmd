---
title: "statlearning-final"
author: "Horatiu"
date: '2022-07-13'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

FIFA 22
first we do libraries

```{r}
library(knitr) 
#library(kableExtra) #nice html tables
#library(magick)     #working with images
library(ggplot2)    #graphs
library(reshape2)   #dataframe reshaping
library(viridis)    #colors
library(stringr)    #working with strings
library(FactoMineR) #factor analysis (PCA)
library(factoextra) #factor analysis (PCA)
#library(kohonen)    #self-organised maps/SOM 

# libraries
library(dplyr)
library(ggplot2)
library(MASS)
#library(randomForest)
library(class)
#library(caret)
install.packages("corrplot")

library(corrplot)
library(gridExtra)
remove.packages(rlang)
install.packages("rlang")
install.packages("https://cran.rstudio.com/bin/windows/contrib/4.1/caret_6.0-92.zip")
install.packages("caret")
library(mlbench)
library(caret)
library(randomForest)
```

## Data Cleaning


```{r}
players_full <- read.csv("C:\\Users\\gioda\\Downloads\\archive (1)\\players_22.csv") #full dataframe
dim(players_full) #full dataset

#summary(players_full)
```

```{r}
players_22 <- subset(players_full, select = c("short_name","club_position","age","height_cm","weight_kg","pace","shooting","passing","dribbling","defending","physic","attacking_crossing","attacking_finishing","attacking_heading_accuracy","attacking_short_passing","attacking_volleys","skill_dribbling","skill_curve","skill_fk_accuracy","skill_long_passing","skill_ball_control","movement_acceleration","movement_sprint_speed","movement_agility","movement_reactions","movement_balance","power_shot_power","power_jumping","power_stamina","power_strength","power_long_shots","mentality_aggression","mentality_interceptions","mentality_positioning","mentality_vision","mentality_penalties","mentality_composure","defending_marking_awareness","defending_standing_tackle","defending_sliding_tackle"))
dim(players_22)


```
```{r}
head(players_22, n=5)
summary(players_22)
```
## Check how many goalkeepers

```{r}
install.packages("stringr")     # Install & load stringr package
library("stringr")
goalkeepers <- str_detect(players_22$club_position, "GK")
sum(goalkeepers)

```
#eliminate goalkeepers
```{r}
players_22<-subset(players_22, club_position!="GK")
which(apply(X = players_22, MARGIN = 2, FUN = anyNA) == TRUE) # check for NA
dim(players_22)
#head(players_22, n = 2)
```

```{r}
players_22 <- na.omit(players_22) # delete NA
dim(players_22)
col<-colnames(players_22)
col
```

```{r}
#we have to melt the dataset to use in ggplot
library(reshape)
library(corrplot)

players_num = subset(players_22, select = -c(short_name,club_position))
players_num$height_cm <- players_num$height_cm - 100
players_m <- melt(players_num)
head(players_m)
cormatrix <- cor(players_num)
corrplot(cor(players_num))
players_m
```
#correlation
```{r}
library(ggplot2)
library(caret)
highcorr <- findCorrelation(cormatrix, cutoff=0.75)
highcorr
col2<-colnames(players_num)
col2<-col2[-highcorr]

corrplot(cor(players_num[col2]), type = 'upper', tl.cex = 0.5) # it looks much better so we use the variables from col 2
col2[18]<- "club_position"
col2
players_model <- subset(players_22, select = c(col2))

```


```{r}
col[highcorr]
#vizualizing positions
unique(players_22$club_position)
```

```{r}
#here we do the cool violin plots to check distributions
p <- ggplot(data = players_m, aes(y = variable, x = value, fill = variable, alpha = 0.7)) + 
             geom_boxplot() + geom_violin() + scale_fill_manual(values = viridis(45)) + guides(fill = "none")
p
```
#one-hot encoding for classification
```{r}
players.pca<-prcomp(players_num,center=TRUE, scale.=TRUE)
summary(players.pca)
players.pca
fviz_eig(players.pca, addlabels = TRUE)
```

```{r}
fviz_pca_var(players.pca, labelsize = 2, alpha.var = 1.0, title = "Factor Plane for the FIFA 22 Data")
```

### train-test split

```{r}
## 70% of the sample size
smp_size <- floor(0.7 * nrow(players_model))

## set the seed to make your partition reproducible
set.seed(123)
train_ind <- sample(seq_len(nrow(players_model)), size = smp_size)

train <- players_model[train_ind, ]
test <- players_model[-train_ind, ]
dim(test)
```

Normalization

```{r}
# normalization function
normalize <-function(x) { (x -min(x))/(max(x)-min(x))   }

# normalize 
players_norm <- as.data.frame(lapply(players_model[, c(1:17)], normalize))

```

We 
```{r}
# column of club_position to factor

n_pos = factor(c(players_model[, c(18)]))

# associate each position to a number

library(fastmatch)
x <- seq(1,29,1)
num_pos <- fmatch(n_pos, unique(c(players_model[, c(18)])))


```
```{r}

# attach new club_position column to players_norm dataframe

players_norm$club_position <- num_pos
head(players_norm)
```

```{r}

# data split
set.seed(123)
data_split <- sample(1:nrow(players_norm), 0.7 * nrow(players_norm))

# extract training set

train <- players_norm[data_split,]
head(train)
dim(train)
```
``` {r}
# extract test set

test <- players_norm[-data_split,]

head(test)
dim(test)
```

We extract 'club_position' column of train dataset because it will be used as 'cl' argument in knn function.

``` {r}
#extract 18th column of train dataset (club_position) that will be used as 'cl' argument in knn function

target_category <- players_norm[data_split, 18]

#extract 18th column of test set to measure accuracy
test_category <- players_norm[-data_split, 18]

head(target_category)
head(test_category)

```


``` {r}
##load the package class
library(class)
##run knn function
test_pred <- knn(train,test,cl=target_category,k=5)
head(test_pred)
```


``` {r}
df_pred=data.frame(test_category,test_pred)
head(df_pred)
```


``` {r}
#create confusion matrix
table <- table(test_category,test_pred)
table
```


``` {r}
#Evaluate the model performance
install.packages("gmodels")
library(gmodels)
CrossTable(x=test_category, y=test_pred,prop.chisq = FALSE)
```


``` {r}

##this function divides the correct predictions by total number of predictions that tell us how accurate the model is.
accuracy <- function(x){sum(diag(x)/(sum(rowSums(x)))) * 100}
accuracy(table)

```


Neural Network



```{r}
library(tidyverse) 
library(neuralnet)

```
Since the club_position column consists of categorical variables, we need to convert the column into a factor

```{r}

players_model <- players_model %>%  
  mutate(club_position=as_factor(club_position))
```

split

```{r}
training_data_rows <- floor(0.70 * nrow(players_model))
set.seed(123) 
training_indices <- sample(c(1:nrow(players_model)), training_data_rows)

```

split d

```{r}
training_data <- players_model[training_indices,] 
test_data <- players_model[-training_indices,]
```



```{r}
print(head(players_model))

```
We build our NN

```{r}
nn=neuralnet(club_position ~ age + height_cm + weight_kg + pace + attacking_crossing + attacking_heading_accuracy + skill_fk_accuracy + skill_long_passing + movement_agility + power_shot_power + power_jumping + power_stamina + power_strength + mentality_aggression + mentality_interceptions + mentality_penalties + mentality_composure
,  
             data=training_data, hidden=c(2,2), linear.output = FALSE)
```

plot nn

```{r}
plot(nn)
```
Testing


```{r}
print(unique(as.character(players_model$club_position)))
```


```{r}

predict <- function(data){ 
  prediction <- data.frame(neuralnet::compute(nn,  

                                              data.frame(data[,-5]))$net.result) 
  labels <- c("RW" , "ST",  "LW" , "RCM" , "CF" , "CDM" , "LCB" , "RDM" , "RS" ,  "LCM" , "SUB", "CAM", "RCB", "LDM", "LB",  "RB",  "LM",  "RM",  "LS",  "CB",  "RES", "RWB", "RF",  "CM",  "LWB", "LAM", "LF",  "RAM" ) 
  prediction_label <- data.frame(max.col(prediction)) %>%  
    mutate(prediction=labels[max.col.prediction.]) %>%  
    select(2) %>%  
    unlist() 

  table(data$club_position, prediction_label) 
}

```

let us check the performance on our training data

```{r}

predict(training_data)

```


